visitedTokens << (visitedTokens as List) + '{%- token %}'
route('{%- token %}') {
  uri '/{%- attributes.uri %}'
  namespace application
  export country: application.country, startedOnDesktop: startedOnDesktop, visitedTokens: visitedTokens
  {% if (isTerminal) { %}terminal(){% } %}
}

requestFields << [:]
requestFiles << [:]

identitymindMapping['profile'] << [
    'static': '{%- attributes?.ednaProfile || "DEFAULT" %}',
]
identitymindMapping['stage'] << [
    'static': {%- attributes?.ednaStage || 3 %},
]
if (application?.tacAgreement) {
  identitymindMapping['memo0'] << [
    'static': 'accepted terms and conditions',
  ]
}
(identitymindMapping as Map).each{ key, val ->
    if (val.static) {
        requestFields[key] << val.static
    } else if (val.application) {
        def appKey = val.application.toString()
        if (application[appKey]) {
            requestFields[key] << application[appKey]
        } else if (val.default) {
            requestFields[key] << val.default
        }
    } else if (val.uploads) {
        def upKey = val.uploads.toString()
        if (uploads[upKey]) {
            requestFiles[key] << uploads[upKey]
        }
    }
}

// croppedImage needed only send when a document validation is happening
if(requestFields["docType"]) { 
    requestFields["croppedImage"] << true 
}

(identitymindMemos as List).eachWithIndex{ val, index ->
    def key = "memo"+ (index+1).toString()
    requestFields[key] << ""
    if (val.static) {
            requestFields[key] << val.static
    } else if (val.application) {
            def appKey = val.application.toString()
        if (application[appKey]) {
            requestFields[key] << application[appKey]
        } else if (val.default) {
            requestFields[key] << val.default
        }
    }
}

// fill up man
if (!requestFields['man']) {
    if (requestFields['tea']) {
        requestFields['man'] << requestFields['tea']
    } else if (requestFields['phn']) {
        requestFields['man'] << requestFields['phn']
    } else if (requestFields['bfn'] && requestFields['bln']) {
        requestFields['man'] << requestFields['bfn'].toString() + ' ' + requestFields['bln'].toString()
    } else {
        requestFields['man'] << identitymindManRandom
    }
}

// data mapping
if (requestFields['assn']) {
    requestFields['assn'] << application.country.toString() + ':' + requestFields['assn'].toString().replaceAll("[^\\d]", "")
}
if (requestFields['assn1']) {
    requestFields['assn1'] << application.country.toString() + ':' + requestFields['assn1'].toString().replaceAll("[^\\d]", "")
}
if (requestFields['assn2']) {
    requestFields['assn2'] << application.country.toString() + ':' + requestFields['assn2'].toString().replaceAll("[^\\d]", "")
}
if (requestFields['dob']) {
    requestFields['dob'] << (new java.text.SimpleDateFormat('yyyy-MM-dd')).format((new java.text.SimpleDateFormat('{%- (formats?.date?.format || "YYYY-MM-DD").replace(/Y/g, "y").replace(/D/g, "d") %}')).parse(requestFields['dob'].toString()))
}
// If we have data in address line 2, append it to bsn field
if (application['address2']) {
    requestFields['bsn'] << requestFields['bsn'].toString() + ' ' + application['address2'].toString()
}

identityMindResult << exchange('AcuantGo - IdentityMind - Consumer') {
    config organizationId: {%- globals.organizationId %}, environment: "{%- globals.ednaEnvironment || "STG" %}", requestFields: requestFields, requestFiles: requestFiles
}

if (identityMindResult) {
    if (identityMindResult.tid) {
        identitymindMapping['tid'] << [
            'static': identityMindResult.tid.toString(),
        ]

        def filesToUpload = (identitymindAttachments as List)
        for(file in filesToUpload){
            exchange('AcuantGo - IdentityMind - Merchant Upload') {
                config organizationId: {%- globals.organizationId %}, environment: "{%- globals.ednaEnvironment || "STG" %}", appId: identityMindResult.tid.toString(), document: file
            }
        }
        identitymindAttachments << []
    }
}

if (identityMindResult) {
    if (identityMindResult.tid) {
        identityMindStateResult << exchange('AcuantGo - IdentityMind - State') {
            config organizationId: {%- globals.organizationId %}, environment: "{%- globals.ednaEnvironment || "STG" %}", retriesWhileDvFinish: true, tid: identityMindResult.tid.toString()
        }
    }
}

{%- outputPath() %}