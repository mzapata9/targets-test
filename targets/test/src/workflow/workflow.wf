// Zenoo DSL file generated at 2024-01-10T21:04:22.073Z


// preinit
dependencies {
    component "sms"
    component "assureid"
    component "identity-mind"
  }
  exchange('AcuantGo - IdentityMind - Consumer') {
    connector('acuantgo-identitymind-consumer')
    timeout 60
  }
  exchange('AcuantGo - IdentityMind - State') {
    connector('acuantgo-identitymind-state')
    retryStrategy('FIX') {
      retry 12
      backoff 5
    }
    timeout 60
  }
  exchange('AcuantGo - IdentityMind - Merchant Upload') {
    connector('acuantgo-identitymind-merchant-upload')
  }
  exchange('AcuantGo - IdentityMind - Webhook') {
    connector('acuantgo-identitymind-webhook')
  }
  exchange('SMS - Hand Off SMS') {
    connector('hand-off-sms')
  }

  
  function("setPreview") {
    handoff.previews[it.name.toString()] << it.file
    handoff.previews
  }
  function("setClassification") {
    it.status
  }
  function("setClassificationBack") {
    it.status
  }
  function("setClassificationSelfie") {
    it.status
  }

  function("validateRecaptchaToken") {

    def recaptchaToken = it.recaptchaToken
 
    def payload = [event: [token: recaptchaToken, siteKey: "<%- BUILD_PARAMS?.recaptchaSiteKey %>"]]
    def recaptchaUrl = "https://recaptchaenterprise.googleapis.com/v1/projects/" + "<%- BUILD_PARAMS?.googleProjectName %>" + "/assessments?key=" + "<%- BUILD_PARAMS?.googleApiKey %>"

    exchange('recaptcha-validation') {
      namespace response
      http {
        url recaptchaUrl
        method "POST"
        jsonBody payload
      }
    }

    if(response.riskAnalysis.score.asType(Float.class) >= 0.5) {
      true
    }

  }

  function("createDocumentInstanceId") {
    def token = it.token
    def assureIdRegion = it.assureIdRegion
 
    exchange('AssureID - Create Document Instance') {
        namespace response
        config assureIdRegion: assureIdRegion, token: token, organizationId: 11, environment: "STG"
    }
 
    response
  }
  function("uploadDocument") {
    def token = it.token
    def assureIdRegion = it.assureIdRegion
    def documentInstanceId = it.documentInstanceId
    def file = it.file
    def side = it.side
 
    exchange('AssureID - Upload Document') {
        namespace response
        config assureIdRegion: assureIdRegion, token: token, documentInstanceId: documentInstanceId, document: file, side: side, organizationId: 11, environment: "STG"
    }
    response
  }

  function('deleteDocument') {
    def token = it.token
    def assureIdRegion = it.assureIdRegion
    def documentInstanceId = it.documentInstanceId
 
    exchange('AssureID - Delete Document') {
        namespace response
        config assureIdRegion: assureIdRegion, token: token, documentInstanceId: documentInstanceId, organizationId: 11, environment: "STG"
    }
    response
}

  function("sendHandoffPing") {
    it.timestamp
  }

  
  function("getAssureIdOAuthToken") {
    def assureIdRegion = it.assureIdRegion
    def authType = it.authType
    exchange('AssureID - OAuth') {
      namespace response
      config assureIdRegion: assureIdRegion, authType: authType, organizationId: 11, environment: "STG"
    }
    response
  }

// path for node "p7hpwr" [-z9b2ek]
path("node--z9b2ek") {
    // --- begin of "WelcomeInteraction" main code ---
    
    visitedTokens << (visitedTokens as List) + '-z9b2ek'
    route('-z9b2ek') {
      uri '/welcome'
      namespace application
      export startedOnDesktop: startedOnDesktop, visitedTokens: visitedTokens
      
    }
    path("node--6szt69") // path to node "-n6spxy"
    
    // --- end of "WelcomeInteraction" main code ---
}

// path for node "-n6spxy" [-6szt69]
path("node--6szt69") {
    // --- begin of "PersonalDetailsInteraction" main code ---
    
    
    // mapping for "personalDetailsFirstName1" (type: basic)
    identitymindMapping['bfn'] << [
      'application': 'personalDetailsFirstName1',
    ]
    
    // mapping for "personalDetailsLastName2" (type: basic)
    identitymindMapping['bln'] << [
      'application': 'personalDetailsLastName2',
    ]
    
    // mapping for "personalDetailsDateOfBirth3" (type: basic)
    identitymindMapping['dob'] << [
      'application': 'personalDetailsDateOfBirth3',
    ]
    
    
    visitedTokens << (visitedTokens as List) + '-6szt69'
    route('-6szt69') {
      uri '/personal-details'
      //validate {
      //  
      //    personalDetailsFirstName1
      //    personalDetailsLastName2
      //    personalDetailsDateOfBirth3
      //}
      namespace application
      export country: application.country, startedOnDesktop: startedOnDesktop, visitedTokens: visitedTokens
      
    }
    path("node--bfwyrg") // path to node "-qte4st"
    
    // --- end of "PersonalDetailsInteraction" main code ---
}

// path for node "-qte4st" [-bfwyrg]
path("node--bfwyrg") {
    // --- begin of "ContactDetailsInteraction" main code ---
    
    
    // mapping for "contactDetailsEmail1" (type: basic)
    identitymindMapping['tea'] << [
      'application': 'contactDetailsEmail1',
    ]
    
    // mapping for "contactDetailsMobile2" (type: basic)
    identitymindMapping['phn'] << [
      'application': 'contactDetailsMobile2',
    ]
    
    
    visitedTokens << (visitedTokens as List) + '-bfwyrg'
    route('-bfwyrg') {
      uri '/contact-details'
      //validate {
      //  
      //    contactDetailsEmail1
      //    contactDetailsMobile2
      //}
      namespace application
      export country: application.country, startedOnDesktop: startedOnDesktop, visitedTokens: visitedTokens
      
    }
    path("node-xxl9s7") // path to node "p1vg4o"
    
    // --- end of "ContactDetailsInteraction" main code ---
}

// path for node "p1vg4o" [xxl9s7]
path("node-xxl9s7") {
    // --- begin of "AddressInteraction" main code ---
    
    if (true || [].findIndexOf({ it == application.country.toString() }) > -1) {
    
      identitymindMapping['bc'] << [
        "application": "city",
      ]
      identitymindMapping['bs'] << [
        "application": "state",
      ]
      identitymindMapping['bsn'] << [
        "application": "address",
      ]
      identitymindMapping['bz'] << [
        "application": "postalCode",
      ]
    
      
    
      visitedTokens << (visitedTokens as List) + 'xxl9s7'
      route('xxl9s7') {
        uri '/address'
        //validate {
        //  
        //}
        namespace application
        export country: application.country, startedOnDesktop: startedOnDesktop, visitedTokens: visitedTokens
        
      }
    
      if (application.addressCountry) {
        application.country << application.addressCountry
      }
    
    }
    
    
    
    path("node-vhbx4a") // path to node "n7gpi0"
    
    // --- end of "AddressInteraction" main code ---
}

// path for node "n7gpi0" [vhbx4a]
path("node-vhbx4a") {
    // --- begin of "VerifyInteraction" main code ---
    
    visitedTokens << (visitedTokens as List) + 'vhbx4a'
    
    
    if (!forcedDocumentType) {
      
      route('document-type-vhbx4a') {
        uri '/document-type-document-verification'
        namespace application
        function("deleteDocument"){}
        export country: application.country, startedOnDesktop: startedOnDesktop, visitedTokens: visitedTokens
        function("validateRecaptchaToken") {}
      }
      
    }
    
    
    
    
    // find "phn" field, if exist
    mobile << ""
    (identitymindMapping as Map).each{ key, val ->
      if (key == 'phn') {
        if (val.application) {
          def appKey = val.application.toString()
          if (application[appKey]) {
            mobile << application[appKey]
          }
        }
      }
    }
    
    smsCounter << 11
    
    
    
    route('upload-vhbx4a') {
      uri '/upload-document-verification'
    
      namespace uploads
    
      function("setPreview") {
        namespace handoff.previews
      }
    
      function("sendHandoffPing") {
        namespace handoff.lastHandoffTimestamp
      }
      
      function("createDocumentInstanceId") {}
      
      function("uploadDocument"){}
    
      function("validateRecaptchaToken") {}
    
      function("setClassification") {
        namespace handoff.classificationStatus
      }
    
      function("setClassificationBack") {
        namespace handoff.classificationStatusBack
      }
    
      function("setClassificationSelfie") {
        namespace handoff.classificationStatusSelfie
      }
    
      function("getAssureIdOAuthToken") {}
      export country: application.country, startedOnDesktop: startedOnDesktop, visitedTokens: visitedTokens, documentCountry: application.documentCountry, documentType: application.documentType, mobile: mobile, forcedDocumentType: forcedDocumentType
      
    }
    handoff.previews << [:]
    handoff.lastHandoffTimestamp << 0
    path("node--qjzlx7") // path to node "xf3gld"
    
    // --- end of "VerifyInteraction" main code ---
}

// path for node "xf3gld" [-qjzlx7]
path("node--qjzlx7") {
    // --- begin of "ProcessingInteraction" main code ---
    
    visitedTokens << (visitedTokens as List) + '-qjzlx7'
    route('-qjzlx7') {
      uri '/edna-processing'
      namespace application
      export country: application.country, startedOnDesktop: startedOnDesktop, visitedTokens: visitedTokens
      
    }
    
    requestFields << [:]
    requestFiles << [:]
    
    identitymindMapping['profile'] << [
        'static': 'ico_4id',
    ]
    identitymindMapping['stage'] << [
        'static': 3,
    ]
    if (application?.tacAgreement) {
      identitymindMapping['memo0'] << [
        'static': 'accepted terms and conditions',
      ]
    }
    (identitymindMapping as Map).each{ key, val ->
        if (val.static) {
            requestFields[key] << val.static
        } else if (val.application) {
            def appKey = val.application.toString()
            if (application[appKey]) {
                requestFields[key] << application[appKey]
            } else if (val.default) {
                requestFields[key] << val.default
            }
        } else if (val.uploads) {
            def upKey = val.uploads.toString()
            if (uploads[upKey]) {
                requestFiles[key] << uploads[upKey]
            }
        }
    }
    
    // croppedImage needed only send when a document validation is happening
    if(requestFields["docType"]) { 
        requestFields["croppedImage"] << true 
    }
    
    (identitymindMemos as List).eachWithIndex{ val, index ->
        def key = "memo"+ (index+1).toString()
        requestFields[key] << ""
        if (val.static) {
                requestFields[key] << val.static
        } else if (val.application) {
                def appKey = val.application.toString()
            if (application[appKey]) {
                requestFields[key] << application[appKey]
            } else if (val.default) {
                requestFields[key] << val.default
            }
        }
    }
    
    // fill up man
    if (!requestFields['man']) {
        if (requestFields['tea']) {
            requestFields['man'] << requestFields['tea']
        } else if (requestFields['phn']) {
            requestFields['man'] << requestFields['phn']
        } else if (requestFields['bfn'] && requestFields['bln']) {
            requestFields['man'] << requestFields['bfn'].toString() + ' ' + requestFields['bln'].toString()
        } else {
            requestFields['man'] << identitymindManRandom
        }
    }
    
    // data mapping
    if (requestFields['assn']) {
        requestFields['assn'] << application.country.toString() + ':' + requestFields['assn'].toString().replaceAll("[^\\d]", "")
    }
    if (requestFields['assn1']) {
        requestFields['assn1'] << application.country.toString() + ':' + requestFields['assn1'].toString().replaceAll("[^\\d]", "")
    }
    if (requestFields['assn2']) {
        requestFields['assn2'] << application.country.toString() + ':' + requestFields['assn2'].toString().replaceAll("[^\\d]", "")
    }
    if (requestFields['dob']) {
        requestFields['dob'] << (new java.text.SimpleDateFormat('yyyy-MM-dd')).format((new java.text.SimpleDateFormat('MM/dd/yyyy')).parse(requestFields['dob'].toString()))
    }
    // If we have data in address line 2, append it to bsn field
    if (application['address2']) {
        requestFields['bsn'] << requestFields['bsn'].toString() + ' ' + application['address2'].toString()
    }
    
    identityMindResult << exchange('AcuantGo - IdentityMind - Consumer') {
        config organizationId: 11, environment: "STG", requestFields: requestFields, requestFiles: requestFiles
    }
    
    if (identityMindResult) {
        if (identityMindResult.tid) {
            identitymindMapping['tid'] << [
                'static': identityMindResult.tid.toString(),
            ]
    
            def filesToUpload = (identitymindAttachments as List)
            for(file in filesToUpload){
                exchange('AcuantGo - IdentityMind - Merchant Upload') {
                    config organizationId: 11, environment: "STG", appId: identityMindResult.tid.toString(), document: file
                }
            }
            identitymindAttachments << []
        }
    }
    
    if (identityMindResult) {
        if (identityMindResult.tid) {
            identityMindStateResult << exchange('AcuantGo - IdentityMind - State') {
                config organizationId: 11, environment: "STG", retriesWhileDvFinish: true, tid: identityMindResult.tid.toString()
            }
        }
    }
    
    path("node-rjxexa") // path to node "ih6qzv"
    // --- end of "ProcessingInteraction" main code ---
}

// path for node "ih6qzv" [rjxexa]
path("node-rjxexa") {
    // --- begin of "DoneInteraction" main code ---
    
    redirectUrl << ""
    try {
      if (webhookRequestResponse && webhookRequestResponse.redirect) {
        def urlString = webhookRequestResponse.redirect.toString()
        if (urlString.startsWith("http://") || urlString.startsWith("https://")) {
          redirectUrl << urlString
        }
      }
    } catch(Exception e) {
    }
    
    identityMindFinalState << ""
    if (identityMindResult) {
      if (identityMindResult.state) {
          identityMindFinalState << identityMindResult.state.toString()
      }
    }
    // override state from identityMindStateResult if exists 
    if (identityMindStateResult) {
      if (identityMindStateResult.state) {
        identityMindFinalState << identityMindStateResult.state.toString()
      }
    }
    
    visitedTokens << (visitedTokens as List) + 'rjxexa'
    route('rjxexa') {
      uri '/done'
      export country: application.country, startedOnDesktop: startedOnDesktop, visitedTokens: visitedTokens, identityMindResult: identityMindResult, identityMindStateResult: identityMindStateResult, identityMindFinalState: identityMindFinalState, redirectUrl: redirectUrl
      terminal()
    }
    // terminal node, no output path
    
    // --- end of "DoneInteraction" main code ---
}


// register workflow
workflow ("test") {
    
    // workflow additions
    if (it.urlData) {
        application << it.urlData
      }
    
      if (it.documentCountry && it.documentType) {
        application.documentCountry << it.documentCountry
        application.documentType << it.documentType
        forcedDocumentType << true
      }
    
      startedOnDesktop << it.startedOnDesktop
      visitedTokens << []
      handoff.previews << [:]
      handoff.lastHandoffTimestamp << 0
      handoff.classificationStatus << ""
      export handoff
    
      uploads << [:]
      export uploads
    
      smsCounter << 0
      executionUuid << uuid
    
      // random for "man" field
      def generator = { String alphabet, int n ->
        new Random().with {
          (1..n).collect { alphabet[ nextInt( alphabet.length() ) ] }.join()
        }
      }
      identitymindManRandom << generator((('A'..'Z')+('0'..'9')).join(), 10)
    
      identitymindAttachments << []
    
      identitymindMemos << []
      identitymindMapping << [
        // basic
        "profile": [
          "static": "DEFAULT",
        ],
        "stage": [
          "static": 3,
        ],
        "ip": [
          "application": "ip",
        ],
        "dfp": [
          "application": "dfp",
        ],
        "dft": [
          "static": "IO",
        ],
        // welcome
        "bco": [
          "application": "country",
        ],
        // one-to-one mappings
        "tid": [
          "application": "tid",
        ],
        "bc": [
          "application": "bc",
        ],
        "bfn": [
            "application": "bfn",
        ],
        "bln": [
            "application": "bln",
        ],
        "bs": [
            "application": "bs",
        ],
        "bsn": [
            "application": "bsn",
        ],
        "bz": [
            "application": "bz",
        ],
        "dob": [
            "application": "dob",
        ],
        "pbc": [
            "application": "pbc",
        ],
        "phn": [
            "application": "phn",
        ],
        "tea": [
            "application": "tea",
        ],
        "assn": [
            "application": "assn",
        ],
        "man": [
            "application": "man",
        ],
        // verify
        "docCountry": [
          "application": "documentCountry",
        ],
        "docType": [
          "application": "documentType",
        ],
        "croppedImage": [
          static: ""
        ],
        // uploads
        "faceImages[]": [
          "uploads": "selfie",
        ],
        "scanData": [
          "uploads": "idCardFront",
        ],
        "backsideImageData": [
          "uploads": "idCardBack",
        ],
        "memo0": [
          'static': '',
        ]
      ]
    
      webhookMapping << [:]
    
    // start first node
    path("node--z9b2ek")
}
